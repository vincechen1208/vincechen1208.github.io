<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<style>
  body {
    padding: 100px;
    width: 1000px;
    margin: auto;
    text-align: left;
    font-weight: 300;
    font-family: 'Open Sans', sans-serif;
    color: #121212;
  }
  h1, h2, h3, h4 {
    font-family: 'Source Sans Pro', sans-serif;
  }
</style>
<title>CS 184 Final Project</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link href="https://fonts.googleapis.com/css?family=Open+Sans|Source+Sans+Pro" rel="stylesheet">
</head>


<body>

<h1 align="middle">CS 184: Computer Graphics and Imaging, Spring 2018</h1>
<h1 align="middle">Final Project: 3D Fluid Simulation</h1>
<h2 align="middle">Vincent Chen, Sheng-Yu Wang, Haw-Wei Lin</h2>


 <div align="center">
        <table style="width=100%">
            <tr>
                <td>
                    <video align="middle" width="400" height="600" controls loop>
                        <source src="muted/media7.mp4" type="video/mp4">
                    </video>
                    <figcaption align="middle">3D Real-Time Fluid Simulation</figcaption>
                </td>
            </tr>
        </table>
 </div>

<h2 align="middle">Abstract</h2>
    <p>For our final project, we've chosen to implement 3D real-time fluid simulation by treating fluid as a huge set of particles that interact with each other and move at various velocities. We started off with the "particles" CUDA sample, where only particle collisions are handled. In order to simulate fluid-like motion within the particles, we implemented methods described in [Macklin et al. 2013] to enforce incompressibility. We also handled tensile instability, and enforced other constraints such as vorticity and viscosity. We implemented these methods in CUDA for real-time effects. Finally, we attemped surface rendering in order to make the particles look more like a liquid.</p>
    

<h2 align="middle">Technical Approach</h2>

	<h3>Full Pipeline</h3>
    <img src="image/alg.png" width="400px" align="middle" /> 
    <h3>Incompressibility</h3>
    <p>Instead of doing a physical calculation for the intermolecular attraction and repulsion. Here we adopted the constraint method to simulate a non-physical but realistic incompressibility effect. To formulate the constraint, we can leverage the fact that incompressibility implies constant local densities. First, we calculate the local densities for each particle in our scene, where particle <i><b>i</b></i> has a local density <i><b>œÅi</b></i> approximated by the following: <br>
        <img src="image/comp-1.png" width="200px" align="middle" />, where <i><b>œÅ0</b></i> is the rest density we define. <br>

    With this approximation, we can set up a state function: <br>
        <img src="image/comp-0.png" width="200px" align="middle" /> <br>
    In order to enforce constant density, we would want the state function to be <i><b>0</b></i>. <br>
    Therefore, given position <i><b>p</b></i> after a Euler update, one need to add a small modification <i><b>Œîp</b></i> so that: <br>
        <img src="image/comp-2.png" width="120px" align="middle" /> <br>
    By doing a taylor expansion and adding a relaxation term <b>ùúÄ</b>, we get the following solutions for <i><b>Œîp</b></i>: <br>
        <img src="image/comp-3.png" width="200px" align="middle" />, 
        <img src="image/comp-4.png" width="300px" align="middle" /> <br>
    The relaxation term <b>ùúÄ</b> acts as a crutial factor to regularize the contraint correction in order to stabilize the dynamics. <br>
    Also, for each frame, incompressibility contraint update and collision update will be applied for a couple of iterations in order to have a more stable motion.</p>


    <h3>Kernel functions</h3>
    <p>Recall that for approximating local density, we uses a function <i><b>W</b></i>. This is the kernel function that give weights according to the distance. Intuitively, we would like to assign a higher density contribution to particles that are close, and the kernel function basically does this thing. <br>
    Empirically, we uses poly6 kernel to approximate the local densities, and spiky kernel to calculate the gradients. The two functions are as follows: <br>
        <img src="image/kernel_poly6.png" width="360px" align="middle" />,  
        <img src="image/kernel_spiky.png" width="360px" align="middle" /> <br></p>

	<h3>Tensile Instability</h3>
	<p>One of the biggest problems we ran into when doing this project was that some particles were affected by negative pressure and tended to clump and cluster together. We then realized that when a particle has too few neighbors and therefore does not satisfy the rest density, it will lead to the clustering and clumping of surrounding particles. This phenomenon is known as tensile instability. In order to solve tensile instability, we implemented the method by Monaghan described in [Macklin et al. 2013]. Following the steps, we added in a correction term when updating the positions of each particle to act as an "artificial pressure" in order to push the clustered particles apart. The correction term is iteself specified in terms of the smoothing kernel we used above for incompressibility and is shown below. The updated position-updated equation is also shown below.</p>

	<img src="image/tensile-1.png" width="300px" align="middle" /> <br>
	<img src="image/tensile-2.png" width="360px" align="middle" />

	<p>In the above equation, ‚àÜq is a random fixed distance within the smoothing kernel radius and k is a small constant. We've fine-tuned these parameters to produce the best visual effects. Since the constant k is purely negative, the above correction term is a purely repulsive force. As a result, each particle now pulls their neighboring particles inward, creating a surface-tension like effect, which further makes the simulation behave more like an actual fluid.</p>

	<h3>Vorticity Confinement</h3>
    <p>Applying constraints are not physical, and unfortunately in this case our implementation will dissipate considerable energy. This generates a undesirable effect where the fluids are not moving enough. In order to add the energy back, we reinforce the local vorticity of the fluid. First, we calculate the current approximate of the local vorticity given as follows: <br>
        <img src="image/vort-0.png" width="300px" align="middle" />, which is the curl of the velocity vector field weighted by the kernel function. <br>
    Afterwards, we apply the additional vorticity force to the particle to enhance the local spinning motion. The force is calculated by: <br>
        <img src="image/vort-1.png" width="150px" align="middle" />, <br> where <i><b>N</b></i> is the normalized position of the particle with respect to local center of mass, and <b>ùúÄ</b> determines how much vorticity we are adding back to the fluid.</p>

    <h3>Viscosity</h3>
    <p>In order to make the particles look even more like a fluid, or more "viscouse", we apply some damping to "stick" the particles together. We update the velocity equation to include this damping term, which is important for coherent motion among the particles. We fine-tune the constant c to produce the best visual results. The updated velocity equation is shown below.</p>

    <img src="image/visc-1.png" width="360px" align="middle" />

<h2 align="middle">Results</h2>
	<h3 align="middle"> No tensile instability, no vorticity, no viscosity, Rest_density = 20, h = 2.0 </h3>
	<div align="center">
        <table style="width=100%">
            <tr>
                <td>
                    <video align="middle" width="400" height="600" controls loop>
                        <source src="muted/media10.mp4" type="video/mp4">
                    </video>
                    <figcaption align="middle">Eps = 5000</figcaption>
                </td>
                <td>
                    <video align="middle" width="400" height="600" controls loop>
                        <source src="muted/media11.mp4" type="video/mp4">
                    </video>
                    <figcaption align="middle">Eps = 50000</figcaption>
                </td>
            </tr>
        </table>
    </div>

    <h3 align="middle"> No vorticity, no viscosity, Rest_density = 20, h = 1.5, Eps = 5000 </h3>
    <div align="center">
        <table style="width=100%">
            <tr>
                <td>
                    <video align="middle" width="400" height="600" controls loop>
                        <source src="muted/media5.mp4" type="video/mp4">
                    </video>
                    <figcaption align="middle">No tensile instability</figcaption>
                </td>
                <td>
                    <video align="middle" width="400" height="600" controls loop>
                        <source src="muted/media7.mp4" type="video/mp4">
                    </video>
                    <figcaption align="middle">
                    	Tensile Instability: Delta_q = 0.01h, k = 0.0003, n = 1 	
                    </figcaption>
                </td>
            </tr>
        </table>
    </div>

    <h3 align="middle"> With tensile instability, Rest_density = 20, h = 1.5, Eps = 5000 </h3>
    <div align="center">
        <table style="width=100%">
            <tr>
                <td>
                    <video align="middle" width="400" height="600"controls loop>
                        <source src="muted/media6.mp4" type="video/mp4">
                    </video>
                    <figcaption align="middle">No vorticity, no viscosity</figcaption>
                </td>
                <td>
                    <video align="middle" width="400" height="600" controls loop>
                        <source src="muted/media7.mp4" type="video/mp4">
                    </video>
                    <figcaption align="middle">With vorticity and viscosity</figcaption>
                </td>
            </tr>
        </table>
    </div>

    <h3 align="middle"> Final Simulation with 100k particles </h3>
    <div align="center">
        <table style="width=100%">
            <tr>
                <td>
                    <video align="middle" width="400" height="600" controls loop>
                        <source src="muted/media14.mp4" type="video/mp4">
                    </video>
                </td>
            </tr>
        </table>
    </div>
<h2 align="middle">References</h2>
	<ul>
  		<li>Miles Macklin and Matthias M√ºller. Position based fluids. ACM Trans.Graph., 32(4):104:1‚Äì104:12, July 2013.</li>
  		<li>Matthias M√ºller, David Charypar, and Markus Gross. Particle-based fluid simulation for interactive applications. In Proceedings of the 2003 ACM SIGGRAPH/Eurographics Symposium on Computer Animation, SCA ‚Äô03, pages 154‚Äì159, Aire-la-Ville, Switzerland, Switzerland, 2003. Eurographics Association</li>
	</ul> 
<h2 align="middle">Contributions</h2>
	<ul>
		<li> Haw-Wei Lin: </li>
		<li> Sheng-Yu Wang: </li>
		<li> Vincent Chen: </li>
	</ul>	

</body>
</html>